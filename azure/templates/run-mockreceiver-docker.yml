steps:

  - template: "azure/components/aws-assume-role.yml@common"
    parameters:
      role: "auto-ops"
      profile: "apim-dev"
      aws_account: "dev" 

  - bash: |

        dockerImageName=prismmockreceiver:$(Build.BuildId)
        echo ${dockerImageName}
        docker build -t ${dockerImageName} -f Dockerfile .
        cd ../infra
        echo "configure list"
        aws configure list
        echo "get caller id"
        aws --profile=apim-dev sts get-caller-identity
        aws --profile=apim-dev s3 ls 

        account_id="$(aws sts get-caller-identity --query Account --output text)"
        

        aws ecr get-login-password --profile apim-dev --region eu-west-2 | docker login --username AWS --password-stdin 790083933819.dkr.ecr.eu-west-2.amazonaws.com
        echo "docker login succeeded"

        mock_receiver_repository_url=790083933819.dkr.ecr.eu-west-2.amazonaws.com/gpconnect-infra-dev
        docker push ${mock_receiver_repository_url}:$(Build.BuildId)

    displayName: Build MockReceiver Docker
    workingDirectory: "$(Pipeline.Workspace)/s/$(SERVICE_NAME)/PrismMockReceiver"




steps:

  - template: "azure/components/aws-assume-role.yml@common"
    parameters:
      role: "auto-ops"
      profile: "apim-dev"
      aws_account: "dev"

  - bash: |

        export AWS_PROFILE=apim-dev
        account_id="$(aws sts get-caller-identity --query Account --output text)"
        aws ecr get-login-password --region eu-west-2 | docker login --username AWS --password-stdin ${account_id}.dkr.ecr.eu-west-2.amazonaws.com

        mock_provider_repository_url=${account_id}.dkr.ecr.eu-west-2.amazonaws.com/gpconnect-infra-dev
        echo  "Pull request number "$(System.PullRequest.PullRequestNumber)
        pr_tag=pr-$(System.PullRequest.PullRequestNumber)
        build_tag=$(Build.BuildId)
        dockerImageName=${mock_provider_repository_url}:$pr_tag
        echo "Docker image build with PR number"${dockerImageName}
        docker build -t ${dockerImageName} .
        echo "Docker tagged with BuildId"
        docker tag ${dockerImageName} ${mock_provider_repository_url}:${build_tag}
        docker push -a ${mock_provider_repository_url}

    displayName: Build and Push prism_mock_provider Docker to ECR
    workingDirectory: "$(Pipeline.Workspace)/s/$(SERVICE_NAME)/prism_mock_provider"
